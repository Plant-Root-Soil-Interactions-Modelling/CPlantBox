FROM ubuntu:22.04

ARG DEBIAN_FRONTEND=noninteractive

# Base toolchain and Python runtime suitable for building and testing CPlantBox
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      build-essential \
      cmake \
      git \
      pkg-config \
      libgl1 \
      libxrender1 \
      libxt6 \
      libsm6 \
      libxext6 \
      libx11-6 \
      libxau6 \
      libxdmcp6 \
      libosmesa6 \
      libglx-mesa0 \
      libgl1-mesa-dri \
      libglu1-mesa \
      xvfb \
      xauth \
      python3-venv \
      python3-dev \
      python3-pip \
      ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Python packages needed for tests (headless). Prefer OSMesa-based VTK to avoid X/EGL.
RUN python3 -m pip install -U pip pytest numpy scipy matplotlib pandas && \
    python3 -m pip install vtk-osmesa || python3 -m pip install vtk

WORKDIR /src

# This image intentionally does not COPY the source code. Use a bind mount.
# Example usage (from repository root):
#   docker build -f docker/Dockerfile.ubuntu-test-env -t cplantbox-ubuntu-test-env .
#   docker run --rm -t -v "$PWD":/src -w /src cplantbox-ubuntu-test-env bash -lc "\
#     git submodule update --init --recursive && cmake . && make -j\$(nproc) && \
#     OMP_NUM_THREADS=1 python3 -m pytest -q test && \
#     OMP_NUM_THREADS=1 python3 tutorial/examples/example1a_small.py"

CMD ["bash", "-lc", "echo 'Container ready. Mount your repo to /src and run build/tests as needed.'"]


